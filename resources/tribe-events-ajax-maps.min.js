(function(q,n,b,l,k,e,d,a,f,r){b.extend(tribe_ev.fn,{map_add_marker:function(a,e,g,f,k){a=new google.maps.LatLng(a,e);var l=new google.maps.Marker({position:a,map:d.map,title:g}),m=new google.maps.InfoWindow;e=g;k&&(e=b("<div/>").append(b("<a/>").attr("href",k).text(g)).html());g="Event: "+e;f&&(g=g+"<br/>Address: "+f);m.setContent(g);google.maps.event.addListener(l,"click",function(a){m.open(d.map,l)});d.markers.push(l);d.refine&&l.setVisible(!1);d.bounds.extend(a)}});d.geocoder=new google.maps.Geocoder;
d.bounds=new google.maps.LatLngBounds;b(n).ready(function(){function p(){if(b("#tribe-bar-geoloc").length){var a=b("#tribe-bar-geoloc").val(),d=b("#tribe_events_filter_item_geofence"),e=b("#tribe-bar-geoloc-lat, #tribe-bar-geoloc-lng");a.length?d.show():(d.hide(),e.length&&e.val(""))}}function s(){a.ajax_running=!0;a.params={action:"tribe_geosearch",tribe_paged:a.paged,tribe_event_display:a.view};b(k).trigger("tribe_ev_serializeBar");a.params=b.param(a.params);b(k).trigger("tribe_ev_collectParams")}
function g(){b("#tribe-events-content .tribe-events-loop").tribe_spin();t();a.popping||(s(),a.pushstate=!1,a.initial_load||(a.do_string=!0));b.post(GeoLoc.ajaxurl,a.params,function(c){b(k).trigger("tribe_ev_ajaxStart").trigger("tribe_ev_mapView_AjaxStart");e.enable_inputs("#tribe_events_filters_form","input, select");c.success&&(a.ajax_running=!1,l.ajax_response={total_count:parseInt(c.total_count),view:c.view,max_pages:c.max_pages,tribe_paged:c.tribe_paged,timestamp:(new Date).getTime()},a.initial_load=
!1,b("#tribe-events-content").replaceWith(c.html),"map"===c.view?c.max_pages==c.tribe_paged?b(".tribe-events-nav-next").hide():b(".tribe-events-nav-next").show():c.max_pages==c.tribe_paged?b(".tribe-events-nav-previous").hide():b(".tribe-events-nav-previous").show(),0===l.ajax_response.total_count&&b(".tribe-events-sub-nav").remove(),b.each(c.markers,function(a,b){e.map_add_marker(b.lat,b.lng,b.title,b.address,b.link)}),f.pushstate&&(a.page_title=b("#tribe-events-header").data("title"),n.title=a.page_title,
a.do_string&&history.pushState({tribe_paged:a.paged,tribe_params:a.params},a.page_title,l.cur_url+"?"+a.params),a.pushstate&&history.pushState({tribe_paged:a.paged,tribe_params:a.params},a.page_title,l.cur_url)),b(k).trigger("tribe_ev_ajaxSuccess").trigger("tribe_ev_mapView_AjaxSuccess"),0<c.markers.length&&u())})}function x(c){"change_view"!=tribe_events_bar_action&&(c.preventDefault(),a.ajax_running||(a.paged=1,a.view="map",a.popping=!1,f.pushstate?e.pre_ajax(function(){g(null)}):e.pre_ajax(function(){b(k).trigger("tribe_ev_reloadOldBrowser")})))}
function t(){if(d.markers){for(i in d.markers)d.markers[i].setMap(null);d.markers.length=0;d.bounds=new google.maps.LatLngBounds}}function u(){d.map.fitBounds(d.bounds);13<d.map.getZoom()&&d.map.setZoom(13)}function m(){b("#tribe-events-footer, #tribe-events-header").find(".tribe-events-ajax-loading").hide()}p();var y=b("#tribe-events"),z=b("#tribe-bar-geoloc"),v=b("#tribe-geo-options"),h={zoom:5,center:new google.maps.LatLng(GeoLoc.center.max_lat,GeoLoc.center.max_lng),mapTypeId:google.maps.MapTypeId.ROADMAP};
n.getElementById("tribe-geo-map")&&(d.map=new google.maps.Map(n.getElementById("tribe-geo-map"),h),d.bounds=new google.maps.LatLngBounds,h=new google.maps.LatLng(GeoLoc.center.min_lat,GeoLoc.center.min_lng),d.bounds.extend(h),h=new google.maps.LatLng(GeoLoc.center.max_lat,GeoLoc.center.max_lng),d.bounds.extend(h));b().placeholder&&b("#tribe-geo-location").placeholder();if(f.map_view()){var h=e.get_url_param("tribe_paged"),A=e.get_url_param("tribe_event_display");h&&(a.paged=h);a.view="map";"past"==
A&&(a.view="past");e.tooltips()}f.map_view()&&l.params?(h=l.params,0<=e.in_params(h,"tribe_geosearch")||(h+="&action=tribe_geosearch"),0<=e.in_params(h,"tribe_paged")||(h+="&tribe_paged=1"),a.params=h,a.do_string=!1,a.pushstate=!1,a.popping=!0,e.pre_ajax(function(){g()})):f.map_view()&&(a.do_string=!1,a.pushstate=!1,a.popping=!1,a.initial_load=!0,e.pre_ajax(function(){g()}));f.pushstate&&f.map_view()&&(history.replaceState({tribe_paged:a.paged,tribe_params:a.params},"",location.href),b(q).on("popstate",
function(b){if(b=b.originalEvent.state)a.do_string=!1,a.pushstate=!1,a.popping=!0,a.params=b.tribe_params,a.paged=b.tribe_paged,e.pre_ajax(function(){g()}),e.set_form(a.params)}));f.map_view()&&(y.on("click",".tribe-geo-option-link",function(c){c.preventDefault();c.stopPropagation();c=b(this);b(".tribe-geo-option-link").removeClass("tribe-option-loaded");c.addClass("tribe-option-loaded");z.val(c.text());b("#tribe-bar-geoloc-lat").val(d.geocodes[c.data("index")].geometry.location.lat());b("#tribe-bar-geoloc-lng").val(d.geocodes[c.data("index")].geometry.location.lng());
a.do_string=!0;a.pushstate=!1;a.popping=!1;f.pushstate?e.pre_ajax(function(){g();v.hide()}):e.pre_ajax(function(){b(k).trigger("tribe_ev_reloadOldBrowser")})}),b("body").on("click",function(){v.hide()}),e.snap("#tribe-events-content-wrapper","#tribe-events-content-wrapper","#tribe-events-footer .tribe-events-nav-previous a, #tribe-events-footer .tribe-events-nav-next a"));b(k).on("tribe_ev_reloadOldBrowser",function(){s();q.location=l.cur_url+"?"+a.params});if(f.map_view()){var w;b("#tribe-geo-map-wrapper").resize(function(){w=
d.map.getCenter();google.maps.event.trigger(d.map,"resize");d.map.setCenter(w)});b("#tribe-events").on("click","li.tribe-events-nav-next a",function(c){c.preventDefault();a.ajax_running||("past"===a.view?"1"==a.paged?a.view="map":a.paged--:a.paged++,a.popping=!1,f.pushstate?e.pre_ajax(function(){g()}):e.pre_ajax(function(){b(k).trigger("tribe_ev_reloadOldBrowser")}))}).on("click","li.tribe-events-nav-previous a",function(c){c.preventDefault();a.ajax_running||("map"===a.view?"1"==a.paged?a.view="past":
a.paged--:a.paged++,a.popping=!1,f.pushstate?e.pre_ajax(function(){g(null)}):e.pre_ajax(function(){b(k).trigger("tribe_ev_reloadOldBrowser")}))})}if(GeoLoc.map_view&&b("form#tribe-bar-form").length)b("#tribe-events-bar").on("changeDate","#tribe-bar-date",function(a){x(a)});if(GeoLoc.map_view)b(k).on("tribe_ev_runAjax",function(){g()});f.map_view()&&(b("form#tribe-bar-form").on("submit",function(){if("change_view"!=tribe_events_bar_action){a.paged=1;b("#tribe-events-footer, #tribe-events-header").find(".tribe-events-ajax-loading").show();
b(".tribe-events-sub-nav").remove();var c=b("#tribe-bar-geoloc").val();return""!==c?(a.do_string=!0,a.pushstate=!1,a.popping=!1,t(),b("#tribe-geo-results").empty(),b("#tribe-geo-options").hide(),b("#tribe-geo-options #tribe-geo-links").empty(),e.process_geocoding(c,function(a){d.geocodes=a;m();var c=a[0].geometry.location.lat();a=a[0].geometry.location.lng();c&&b("#tribe-bar-geoloc-lat").val(c);a&&b("#tribe-bar-geoloc-lng").val(a);1<d.geocodes.length?(e.print_geo_options(),p(),u()):f.pushstate?(p(),
g(d.geocodes[0])):b(k).trigger("tribe_ev_reloadOldBrowser")}),!1):""===c?(b("#tribe-bar-geoloc-lat").val(""),b("#tribe-bar-geoloc-lng").val(""),b("#tribe-geo-options").hide(),f.pushstate?(a.do_string=!0,a.pushstate=!1,a.popping=!1,p(),g()):b(k).trigger("tribe_ev_reloadOldBrowser"),m(),!1):!0}}),a.view&&r&&debug.timeEnd("Tribe JS Init Timer"));r&&debug.info("TEC Debug: tribe-events-ajax-maps.js successfully loaded")})})(window,document,jQuery,tribe_ev.data,tribe_ev.events,tribe_ev.fn,tribe_ev.geoloc,
tribe_ev.state,tribe_ev.tests,tribe_debug);
